<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Slimme Klusassistent</title>
    <!-- We use the Tailwind CSS CDN to load styles directly, removing the need for a complex build setup. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .loader {
        width: 24px;
        height: 24px;
        border: 2px solid #e5e7eb;
        border-bottom-color: #1f2937;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }
      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .list-item-enter {
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        0% {
          opacity: 0;
          transform: translateY(-10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      #toast {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: bottom 0.5s ease-in-out;
        z-index: 1000;
      }
      #toast.show {
        bottom: 20px;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <!-- Scherm 1: Input & Opgeslagen Klussen -->
    <div
      id="scherm1"
      class="w-full max-w-md mx-auto h-screen flex flex-col p-4"
    >
      <header class="text-center py-6 flex-shrink-0">
        <h1 class="text-xl font-semibold text-slate-800">
          Slimme Klusassistent
        </h1>
      </header>

      <main class="flex-grow flex flex-col min-h-0">
        <div class="mb-4 flex-shrink-0">
          <label
            for="klusInput"
            class="text-sm font-medium text-slate-700 mb-2 block"
            >Nieuwe klus</label
          >
          <textarea
            id="klusInput"
            class="w-full h-32 p-3 bg-white border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-base placeholder:text-slate-400"
            placeholder="Omschrijf je klus..."
          ></textarea>
          <p class="text-xs text-slate-500 mt-2 text-center">
            Tip: gebruik de microfoon op je mobiele toetsenbord voor
            spraak-naar-tekst.
          </p>
        </div>

        <div class="flex-grow overflow-y-auto border-t border-slate-200 pt-4">
          <h2 class="text-sm font-medium text-slate-700 mb-2">
            Opgeslagen klussen
          </h2>
          <div id="opgeslagenKlussenLijst" class="space-y-2">
            <!-- Dynamisch gevuld -->
          </div>
        </div>
      </main>

      <footer class="pt-4 flex-shrink-0">
        <button
          id="planButton"
          class="w-full bg-slate-900 text-white font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-slate-800 transition active:scale-95 flex items-center justify-center"
        >
          Maak een slim plan
        </button>
      </footer>
    </div>

    <!-- Scherm 2: Laden -->
    <div
      id="scherm2"
      class="w-full max-w-md mx-auto h-screen flex-col justify-center items-center p-4 hidden"
    >
      <div class="loader"></div>
      <p class="mt-4 text-slate-600 font-medium">Plan wordt gegenereerd...</p>
    </div>

    <!-- Scherm 3: Output -->
    <div
      id="scherm3"
      class="w-full max-w-md mx-auto min-h-screen flex flex-col p-4"
    >
      <header class="text-center py-6 flex-shrink-0">
        <h1 class="text-xl font-semibold text-slate-800">Jouw Klusplan</h1>
      </header>
      <main id="planOutput" class="flex-grow space-y-4 overflow-y-auto"></main>
      <footer class="py-4 mt-4 space-y-2 flex-shrink-0">
        <button
          id="bewaarButton"
          class="w-full bg-slate-900 text-white font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-slate-800 transition active:scale-95"
        >
          Bewaar & sluit
        </button>
        <button
          id="annuleerButton"
          class="w-full bg-white text-slate-800 font-semibold py-3 px-4 rounded-lg border border-slate-300 shadow-sm hover:bg-slate-100 transition"
        >
          Annuleren
        </button>
      </footer>
    </div>

    <!-- Toast Notificatie -->
    <div id="toast"></div>

    <script type="module">
      // =================================================================
      // KLUSASSISTENT APP - v8 (LocalStorage Versie)
      // =================================================================

      // --- Globale Variabelen ---
      let currentPlanData = null;
      let opgeslagenKlussen = [];

      // --- Hoofdfunctie ---
      function main() {
        const ui = {
          scherm1: document.getElementById('scherm1'),
          scherm2: document.getElementById('scherm2'),
          scherm3: document.getElementById('scherm3'),
          klusInput: document.getElementById('klusInput'),
          planButton: document.getElementById('planButton'),
          planOutput: document.getElementById('planOutput'),
          bewaarButton: document.getElementById('bewaarButton'),
          annuleerButton: document.getElementById('annuleerButton'),
          opgeslagenKlussenLijst: document.getElementById(
            'opgeslagenKlussenLijst'
          ),
          toast: document.getElementById('toast'),
        };

        const showToast = (message, isError = true) => {
          ui.toast.textContent = message;
          ui.toast.style.backgroundColor = isError ? '#dc2626' : '#22c55e';
          ui.toast.classList.add('show');
          setTimeout(() => {
            ui.toast.classList.remove('show');
          }, 3000);
        };

        const toonScherm = schermId => {
          [ui.scherm1, ui.scherm2, ui.scherm3].forEach(s =>
            s.classList.add('hidden')
          );
          document.getElementById(schermId).classList.remove('hidden');
          document.getElementById(schermId).classList.add('flex');
        };

        const startNieuweKlus = () => {
          toonScherm('scherm1');
          ui.klusInput.value = '';
          ui.planOutput.innerHTML = '';
          currentPlanData = null;
          ui.bewaarButton.classList.remove('hidden');
          ui.annuleerButton.textContent = 'Annuleren';
          loadOpgeslagenKlussen();
        };

        const genereerPlan = async () => {
          const userInput = ui.klusInput.value.trim();
          if (userInput === '') {
            showToast('Omschrijf eerst je klus.');
            return;
          }
          toonScherm('scherm2');
          ui.planButton.disabled = true;
          ui.planButton.innerHTML = '<div class="loader"></div>';

          try {
            const apiUrl = '/api/proxy';
            const payload = { userInput: userInput };

            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                errorData.error || `Serverfout: ${response.status}`
              );
            }

            const result = await response.json();

            if (
              result.candidates &&
              result.candidates[0].content.parts.length > 0
            ) {
              currentPlanData = JSON.parse(
                result.candidates[0].content.parts[0].text
              );
              currentPlanData.userInput = userInput;
              currentPlanData.status = 'Draft'; // Add status to new plan
              toonPlan(currentPlanData);
            } else {
              throw new Error('Ongeldig antwoord van de AI.');
            }
          } catch (error) {
            console.error('Fout bij genereren:', error);
            showToast(error.message);
            startNieuweKlus();
          } finally {
            ui.planButton.disabled = false;
            ui.planButton.innerHTML = 'Maak een slim plan';
          }
        };

        const toonPlan = (data, isViewing = false) => {
          const materialenHTML =
            data.materialen && data.materialen.length > 0
              ? `
                    <div class="bg-white p-4 rounded-xl border border-slate-200">
                        <h3 class="font-semibold mb-3 text-slate-800">Benodigde Materialen</h3>
                        <div class="space-y-3">
                            ${data.materialen
                              .map(
                                cat => `
                                <div>
                                    <h4 class="font-medium text-sm text-slate-600">${
                                      cat.categorie
                                    }</h4>
                                    <ul class="space-y-1 text-sm list-disc list-inside pl-2">
                                        ${cat.items
                                          .map(
                                            item =>
                                              `<li>${item.item} <span class="text-slate-500">(schatting: €${item.schattingKosten})</span></li>`
                                          )
                                          .join('')}
                                    </ul>
                                </div>
                            `
                              )
                              .join('')}
                        </div>
                    </div>
                `
              : '';

          const aannamesHTML =
            data.aannames && data.aannames.length > 0
              ? `
                    <div class="bg-white p-4 rounded-xl border border-slate-200">
                        <h3 class="font-semibold mb-3 text-slate-800">Aannames</h3>
                        <ul class="space-y-1 text-sm list-disc list-inside">
                            ${data.aannames
                              .map(item => `<li>${item}</li>`)
                              .join('')}
                        </ul>
                    </div>
                `
              : '';

          const prijsopgaveHTML = data.schattingPrijsopgave
            ? `
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                        <h3 class="font-bold text-blue-800">Geschatte Prijsopgave (excl. BTW)</h3>
                        <p class="text-2xl font-bold text-blue-900 mt-1">€${data.schattingPrijsopgave.min} - €${data.schattingPrijsopgave.max}</p>
                        <p class="text-xs text-slate-500 mt-1">Gebaseerd op geschatte uren en materiaalkosten.</p>
                    </div>
                `
            : '';

          const getRange = (range) => (range ? `${range.min}-${range.max}` : 'N/A');

          let actieKnoppenHTML = '';
          if (isViewing) {
            switch (data.status) {
              case 'Draft':
                actieKnoppenHTML = `<button id="maakOfferteButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-blue-700 transition">Maak Offerte</button>`;
                break;
              case 'Proposal':
                actieKnoppenHTML = `
                  <div class="grid grid-cols-2 gap-2">
                    <button id="opdrachtGewonnenButton" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-green-700 transition">Opdracht Gewonnen</button>
                    <button id="opdrachtVerlorenButton" class="w-full bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-red-700 transition">Opdracht Verloren</button>
                  </div>`;
                break;
              case 'Won':
                actieKnoppenHTML = `<button id="projectAfrondenButton" class="w-full bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-gray-700 transition">Project Afronden</button>`;
                break;
            }
          }

          ui.planOutput.innerHTML = `
                    <div class="bg-white p-4 rounded-xl border border-slate-200"><h2 class="text-lg font-semibold">${
                      data.klusTitel || 'Onbekende Klus'
                    }</h2><p class="text-sm text-slate-500">Gestructureerd plan op basis van jouw input.</p></div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200"><div class="grid grid-cols-2 gap-4 text-center"><div><p class="text-2xl font-bold">${
                      getRange(data.schattingUren)
                    }</p><p class="text-sm font-medium text-slate-500">Geschatte uren</p></div><div><p class="text-2xl font-bold">${
            getRange(data.schattingWerkdagen)
          }</p><p class="text-sm font-medium text-slate-500">Werkdagen</p></div></div></div>
                    ${aannamesHTML}
                    <div class="bg-white p-4 rounded-xl border border-slate-200"><h3 class="font-semibold mb-3">Voorgestelde Fasering</h3><ul class="space-y-3 text-sm">${(data.fasering || [])
                      .map(
                        f =>
                          `<li class="flex items-start"><span class="mr-3 mt-1 w-4 h-4 text-white text-xs bg-blue-600 rounded-full flex items-center justify-center font-bold">${f.faseNummer}</span><div><span class="font-semibold">${f.titel}</span> <span class="text-slate-500">(~${f.schattingUren} uur)</span>: ${f.omschrijving}</div></li>`
                      )
                      .join('')}</ul></div>
                    ${materialenHTML}
                    <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg"><div class="flex"><div class="flex-shrink-0"><svg class="h-5 w-5 text-amber-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></div><div class="ml-3"><h3 class="text-sm font-semibold text-amber-800">Slimme Waarschuwingen</h3><div class="mt-1 text-sm text-amber-700"><ul class="list-disc list-inside space-y-1">${(data.slimmeWaarschuwingen || [])
                      .map(w => `<li>${w}</li>`)
                      .join('')}</ul></div></div></div></div>
                    ${prijsopgaveHTML}
                `;

          const footer = document.querySelector('#scherm3 footer');
          footer.innerHTML = `
            ${actieKnoppenHTML}
            <button id="bewaarButton" class="w-full bg-slate-900 text-white font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-slate-800 transition active:scale-95 ${isViewing ? 'hidden' : ''}">Bewaar & sluit</button>
            <button id="annuleerButton" class="w-full bg-white text-slate-800 font-semibold py-3 px-4 rounded-lg border border-slate-300 shadow-sm hover:bg-slate-100 transition">${isViewing ? 'Terug naar overzicht' : 'Annuleren'}</button>
          `;

          // Re-bind events for the new buttons
          document.getElementById('bewaarButton').addEventListener('click', bewaarPlan);
          document.getElementById('annuleerButton').addEventListener('click', startNieuweKlus);
          if (isViewing) {
            document.getElementById('maakOfferteButton')?.addEventListener('click', () => updateStatus('Proposal'));
            document.getElementById('opdrachtGewonnenButton')?.addEventListener('click', () => updateStatus('Won'));
            document.getElementById('opdrachtVerlorenButton')?.addEventListener('click', () => updateStatus('Lost'));
            document.getElementById('projectAfrondenButton')?.addEventListener('click', () => updateStatus('Completed'));
          }

          toonScherm('scherm3');
        };

        const loadOpgeslagenKlussen = () => {
          const klussenJson = localStorage.getItem('opgeslagenKlussen');
          opgeslagenKlussen = klussenJson ? JSON.parse(klussenJson) : [];
          opgeslagenKlussen.sort((a, b) => b.createdAt - a.createdAt); // Sort by newest first

          if (opgeslagenKlussen.length === 0) {
            ui.opgeslagenKlussenLijst.innerHTML = `<p class="text-slate-500 text-sm text-center py-4">Nog geen klussen opgeslagen.</p>`;
            return;
          }
          ui.opgeslagenKlussenLijst.innerHTML = opgeslagenKlussen
            .map(klus => {
              const statusColor = klus.planData.status === 'Draft' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
              return `<div data-id="${klus.id}" class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm list-item-enter cursor-pointer hover:bg-slate-100 transition">
                        <div class="flex justify-between items-center">
                          <p class="font-semibold text-slate-800 pointer-events-none">${klus.planData.klusTitel}</p>
                          <span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">${klus.planData.status}</span>
                        </div>
                        <p class="text-sm text-slate-500 pointer-events-none">${klus.planData.schattingWerkdagen.min}-${klus.planData.schattingWerkdagen.max} dagen</p>
                      </div>`;
            })
            .join('');
        };

        const bewaarPlan = () => {
          if (!currentPlanData) return;

          const newKlus = {
            id: Date.now().toString(),
            userInput: currentPlanData.userInput,
            planData: currentPlanData,
            createdAt: Date.now(),
          };

          opgeslagenKlussen.push(newKlus);
          localStorage.setItem('opgeslagenKlussen', JSON.stringify(opgeslagenKlussen));
          
          showToast('Klus opgeslagen!', false);
          startNieuweKlus();
        };

        const toonOpgeslagenPlan = klusId => {
          const klus = opgeslagenKlussen.find(k => k.id === klusId);
          if (klus) {
            currentPlanData = klus.planData;
            toonPlan(klus.planData, true);
          } else {
            showToast('Kon dit opgeslagen plan niet openen.');
          }
        };

        // --- Event Listeners ---
        ui.planButton.addEventListener('click', genereerPlan);
        ui.bewaarButton.addEventListener('click', bewaarPlan);
        ui.annuleerButton.addEventListener('click', startNieuweKlus);
        ui.opgeslagenKlussenLijst.addEventListener('click', event => {
          const listItem = event.target.closest('[data-id]');
          if (listItem) {
            toonOpgeslagenPlan(listItem.dataset.id);
          }
        });

        // --- Initialisatie ---
        startNieuweKlus();
      }

      // --- Startpunt van de App ---
      document.addEventListener('DOMContentLoaded', main);
    </script>
  </body>
</html>